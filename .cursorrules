# Quant Project - å¼€å‘è§„èŒƒ

## ğŸ—ï¸ é¡¹ç›®æ¶æ„åŸåˆ™

### æ¨¡å—èŒè´£åˆ†ç¦»
- **data_engine**: åªè´Ÿè´£æ•°æ®è·å–ã€ç¼“å­˜ã€å¢é‡æ›´æ–°
- **factors**: åªè´Ÿè´£å› å­è®¡ç®—ï¼Œä¸å¤„ç†æ•°æ®IO
- **models**: åªè´Ÿè´£æ¨¡å‹è®­ç»ƒå’Œé¢„æµ‹
- **backtester**: åªè´Ÿè´£å›æµ‹é€»è¾‘å’Œæ€§èƒ½åˆ†æ
- **utils**: é€šç”¨å·¥å…·å‡½æ•°ï¼Œä¿æŒè½»é‡

### ä»£ç ç»„ç»‡è§„èŒƒ
- æ¯ä¸ªæ¨¡å—å¿…é¡»æœ‰ `__init__.py` å¹¶å¯¼å‡ºæ ¸å¿ƒç±»/å‡½æ•°
- é¿å…å¾ªç¯å¯¼å…¥ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥æˆ–å»¶è¿Ÿå¯¼å…¥
- ç±»å‘½åä½¿ç”¨ PascalCaseï¼Œå‡½æ•°ä½¿ç”¨ snake_case
- å¸¸é‡å…¨å¤§å†™ï¼Œç§æœ‰æ–¹æ³•å‰ç¼€ `_`

## ğŸ“Š æ•°æ®å¤„ç†è§„èŒƒ

### æ•°æ®æ ¼å¼æ ‡å‡†
æ‰€æœ‰æ•°æ®å¿…é¡»éµå¾ªç»Ÿä¸€æ ¼å¼ï¼š
```python
DataFrame Columns:
  - date: timezone-aware DatetimeIndex (US/Eastern for US, Asia/Shanghai for CN)
  - open, high, low, close: float64
  - volume: int64/float64
  - symbol: str
  - market: str ('US' or 'CN')
```

### æ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆå¿…é¡»ï¼‰
1. **ä»·æ ¼å…³ç³»éªŒè¯**: `high >= close >= low`, `high >= open >= low`
2. **ç¼ºå¤±å€¼å¤„ç†**: æ£€æµ‹å¹¶æŠ¥å‘Šç¼ºå¤±å€¼ï¼Œä¸èƒ½é™é»˜å¡«å……
3. **æ—¶åŒºå¤„ç†**: æ‰€æœ‰æ—¶é—´æˆ³å¿…é¡»å¸¦æ—¶åŒºä¿¡æ¯
4. **æ•°æ®ç±»å‹**: ä¸¥æ ¼éµå¾ªä¸Šè¿°ç±»å‹å®šä¹‰

### å¢é‡æ›´æ–°æœºåˆ¶
- ä¼˜å…ˆä½¿ç”¨ `fetch_data_incremental()` è€Œé `fetch_data()`
- ç¼“å­˜ä½¿ç”¨ Parquet æ ¼å¼ï¼Œå…ƒæ•°æ®ç”¨ JSON
- ç¼“å­˜è·¯å¾„: `data/{market}/{symbol}.parquet`
- å…ƒæ•°æ®åŒ…å«: last_update, date_range, data_shape

## ğŸ”¬ å› å­å·¥ç¨‹è§„èŒƒ

### ç®—å­å®ç°è§„åˆ™
1. æ‰€æœ‰ç®—å­å¿…é¡»æ¥å— pandas Series/DataFrame
2. è¿”å›ç›¸åŒé•¿åº¦çš„ Series/DataFrameï¼ˆå‰ç½® NaNï¼‰
3. å‚æ•°éªŒè¯ï¼šçª—å£æœŸ `d >= 1`
4. å‘é‡åŒ–å®ç°ï¼Œé¿å…å¾ªç¯

### å› å­å‘½åè§„èŒƒ
```python
# æ ¼å¼: {æŒ‡æ ‡å}_{çª—å£æœŸ}[_ç»†èŠ‚]
'MA_5'              # 5æ—¥ç§»åŠ¨å¹³å‡
'STD_20'            # 20æ—¥æ ‡å‡†å·®
'RSI_14'            # 14æ—¥RSI
'MACD_12_26_9'      # MACD(12, 26, 9)
'CORR_close_volume_10'  # ä»·æ ¼-æˆäº¤é‡10æ—¥ç›¸å…³æ€§
```

### å› å­è®¡ç®—æœ€ä½³å®è·µ
- ä½¿ç”¨ `.rolling()` è€Œéæ‰‹åŠ¨å¾ªç¯
- æ‰¹é‡è®¡ç®—å› å­ä½¿ç”¨ `groupby().apply()`
- å¤§æ•°æ®é›†ä½¿ç”¨ Dask æˆ– Polars
- å®šæœŸæ£€æŸ¥å› å­æœ‰æ•ˆæ€§ï¼ˆIC > 0.03, IR > 0.5ï¼‰

## ğŸ¤– æ¨¡å‹è®­ç»ƒè§„èŒƒ

### æ—¶é—´åºåˆ—åˆ‡åˆ†ï¼ˆä¸¥æ ¼éµå®ˆï¼‰
```python
# âŒ é”™è¯¯ï¼šéšæœºåˆ‡åˆ†ä¼šå¯¼è‡´æ•°æ®æ³„éœ²
X_train, X_test = train_test_split(X, y)

# âœ… æ­£ç¡®ï¼šæ—¶é—´åºåˆ—åˆ‡åˆ†
split_date = '2023-01-01'
train_mask = dates < split_date
test_mask = dates >= split_date
X_train, y_train = X[train_mask], y[train_mask]
X_test, y_test = X[test_mask], y[test_mask]
```

### RankLoss ä½¿ç”¨æŒ‡å—
- **RankMSE**: æ¨èç”¨äºå¤šè‚¡ç¥¨æ’åºï¼ˆå¦‚ Mag7 è½®åŠ¨ï¼‰
- **PairwiseRank**: é€‚ç”¨äºæˆå¯¹æ¯”è¾ƒåœºæ™¯
- **ListNet**: é€‚ç”¨äºè”åˆæ’åºä¼˜åŒ–

### æ¨¡å‹ä¿å­˜è§„èŒƒ
```python
# ä¿å­˜å†…å®¹ï¼šæ¨¡å‹ + å…ƒæ•°æ®
{
    'model': model,
    'feature_names': feature_names,
    'training_date': datetime.now(),
    'params': model.get_params(),
    'performance': {
        'train_score': train_score,
        'test_score': test_score,
        'sharpe': sharpe_ratio
    }
}
```

## ğŸ§ª å›æµ‹è§„èŒƒ

### ç¾è‚¡å›æµ‹è§„åˆ™
- **äº¤æ˜“åˆ¶åº¦**: T+0ï¼ˆå½“æ—¥å¯ä¹°å–ï¼‰
- **ä½£é‡‘**: å•è¾¹ 0.1%
- **æ»‘ç‚¹**: 0.05%
- **è°ƒä»“é¢‘ç‡**: è‡ªå®šä¹‰ï¼ˆMag7 ç­–ç•¥ä¸ºæ¯å‘¨ä¸€ï¼‰

### Aè‚¡å›æµ‹è§„åˆ™ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰
- **äº¤æ˜“åˆ¶åº¦**: T+1ï¼ˆå½“æ—¥ä¹°å…¥ï¼Œæœ€æ—©æ¬¡æ—¥å–å‡ºï¼‰
- **ä½£é‡‘**: å•è¾¹ 0.03%
- **å°èŠ±ç¨**: å–å‡ºæ—¶ 0.05%ï¼ˆä¹°å…¥æ— ç¨ï¼‰
- **æ¶¨è·Œåœ**: æ£€æŸ¥ Â±10%/Â±20% é™åˆ¶
- **æ»‘ç‚¹**: åˆ†é’Ÿçº§æ’®åˆ

### æ€§èƒ½æŒ‡æ ‡è®¡ç®—
å¿…é¡»åŒ…å«çš„æŒ‡æ ‡ï¼š
- æ”¶ç›Šç±»: `total_return`, `annual_return`, `avg_daily_return`
- é£é™©ç±»: `volatility`, `max_drawdown`, `downside_deviation`
- é£é™©è°ƒæ•´æ”¶ç›Š: `sharpe_ratio`, `sortino_ratio`, `calmar_ratio`
- äº¤æ˜“ç»Ÿè®¡: `total_trades`, `win_rate`, `avg_profit`, `avg_loss`

## ğŸ“ ä»£ç é£æ ¼

### ç±»å‹æ³¨è§£ï¼ˆå¼ºçƒˆæ¨èï¼‰
```python
def fetch_data(
    symbol: str,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None
) -> pd.DataFrame:
    """è·å–è‚¡ç¥¨æ•°æ®"""
    pass
```

### æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆå¿…é¡»ï¼‰
```python
def calculate_alpha158(df: pd.DataFrame) -> pd.DataFrame:
    """
    è®¡ç®— Alpha158 å› å­åº“
    
    Args:
        df: OHLCV DataFrameï¼Œå¿…é¡»åŒ…å« open/high/low/close/volume
    
    Returns:
        å› å­ DataFrameï¼ŒåŒ…å« 158+ ä¸ªå› å­åˆ—
    
    Raises:
        ValueError: å¦‚æœç¼ºå°‘å¿…è¦åˆ—
    """
    pass
```

### æ—¥å¿—è§„èŒƒ
```python
import logging

# ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
logger.info(f"è·å–æ•°æ®: symbol={symbol}, start={start_date}, end={end_date}")
logger.warning(f"æ£€æµ‹åˆ° {missing_count} ä¸ªç¼ºå¤±å€¼")
logger.error(f"æ•°æ®è·å–å¤±è´¥: {e}", exc_info=True)
```

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### å¿…é¡»æµ‹è¯•çš„åœºæ™¯
1. **æ•°æ®å¼•æ“**
   - é¦–æ¬¡è·å–æ•°æ®
   - å¢é‡æ›´æ–°é€»è¾‘
   - å¼‚å¸¸è‚¡ç¥¨ä»£ç å¤„ç†
   - ç¼“å­˜è¯»å†™

2. **å› å­è®¡ç®—**
   - è¾¹ç•Œæ¡ä»¶ï¼ˆçª—å£æœŸ > æ•°æ®é•¿åº¦ï¼‰
   - NaN å¤„ç†
   - å•è‚¡ç¥¨ vs å¤šè‚¡ç¥¨
   - æ•°å€¼å‡†ç¡®æ€§

3. **å›æµ‹å¼•æ“**
   - T+0 vs T+1 äº¤æ˜“
   - äº¤æ˜“æˆæœ¬è®¡ç®—
   - æŒä»“ç®¡ç†
   - æ€§èƒ½æŒ‡æ ‡è®¡ç®—

### æµ‹è¯•æ–‡ä»¶å‘½å
```
test/
â”œâ”€â”€ test_data_engine.py      # æ•°æ®å¼•æ“æµ‹è¯•
â”œâ”€â”€ test_cn_fetcher.py        # Aè‚¡æ•°æ®æµ‹è¯•
â”œâ”€â”€ test_factors.py           # å› å­è®¡ç®—æµ‹è¯•
â”œâ”€â”€ test_models.py            # æ¨¡å‹æµ‹è¯•
â””â”€â”€ test_backtester.py        # å›æµ‹æµ‹è¯•
```

## ğŸ“¦ ä¾èµ–ç®¡ç†

### ç‰ˆæœ¬é”å®š
åœ¨ `requirements.txt` ä¸­æ˜ç¡®ç‰ˆæœ¬ï¼š
```
pandas>=2.0.0,<3.0.0
numpy>=1.24.0,<2.0.0
scikit-learn>=1.3.0,<2.0.0
```

### é¿å…ä¾èµ–è†¨èƒ€
- ä¼˜å…ˆä½¿ç”¨æ ‡å‡†åº“
- é¿å…å¼•å…¥é‡é‡çº§æ¡†æ¶
- å¯é€‰ä¾èµ–ä½¿ç”¨ extras_require

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®æ“ä½œ
- ä½¿ç”¨ `.loc[]` è€Œé `.iterrows()`
- æ‰¹é‡æ“ä½œè€Œéå¾ªç¯
- åˆ†é’Ÿçº¿æ•°æ®ä½¿ç”¨ Parquet åˆ†åŒºå­˜å‚¨

### å†…å­˜ç®¡ç†
- åŠæ—¶é‡Šæ”¾å¤§ DataFrame
- ä½¿ç”¨ `inplace=True` å‡å°‘å¤åˆ¶
- åˆ†æ‰¹å¤„ç†è¶…å¤§æ•°æ®é›†

## ğŸ“š æ–‡æ¡£æ›´æ–°è§„èŒƒ

### æ–‡æ¡£ç»“æ„
- `README.md`: é¡¹ç›®æ¦‚è§ˆå’Œå¿«é€Ÿå¼€å§‹
- `docs/claude.md`: æ¶æ„è®¾è®¡å’Œå¼€å‘æŒ‡å—ï¼ˆç²¾ç®€ç‰ˆï¼‰
- `docs/QUICKSTART_*.md`: å„æ¨¡å—å¿«é€Ÿå¼€å§‹
- `docs/CHANGELOG.md`: ç‰ˆæœ¬æ›´æ–°æ—¥å¿—
- `.cursorrules`: å¼€å‘è§„èŒƒï¼ˆæœ¬æ–‡ä»¶ï¼‰

### æ–°åŠŸèƒ½å¼€å‘æµç¨‹
1. åœ¨å¯¹åº”æ¨¡å—å®ç°åŠŸèƒ½
2. ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ˆ`test/test_*.py`ï¼‰
3. æ›´æ–° CHANGELOG.mdï¼ˆè®°å½•å˜æ›´ï¼‰
4. å¦‚éœ€è¦ï¼Œåˆ›å»º/æ›´æ–° QUICKSTART æ–‡æ¡£
5. æ›´æ–° README.mdï¼ˆå¦‚æœæ˜¯é‡è¦åŠŸèƒ½ï¼‰

### å¢é‡æ›´æ–°æœ€ä½³å®è·µ
**å¯¹äºæ–°éœ€æ±‚/åŠŸèƒ½æ”¹è¿›ï¼š**
1. åˆ›å»º `docs/TODO.md` è®°å½•å¾…å®ç°åŠŸèƒ½
2. ä½¿ç”¨ Git commit message æ¸…æ™°æè¿°æ”¹åŠ¨
3. æ›´æ–° `CHANGELOG.md` è®°å½•ç‰ˆæœ¬å˜åŒ–
4. å¤§åŠŸèƒ½å®Œæˆåæ›´æ–°å¯¹åº” QUICKSTART æ–‡æ¡£

**ä¸è¦ï¼š**
- åœ¨ `claude.md` ä¸­å†™è¯¦ç»†å®ç°ç»†èŠ‚
- åœ¨å¤šå¤„æ–‡æ¡£é‡å¤ç›¸åŒå†…å®¹
- è¿‡åº¦è®¾è®¡å°šæœªå®ç°çš„åŠŸèƒ½

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: æ—¶åŒºå¤„ç†æ··ä¹±æ€ä¹ˆåŠï¼Ÿ
A: ç»Ÿä¸€ä½¿ç”¨ `pd.to_datetime(...).tz_localize()` å’Œ `.tz_convert()`

### Q: å› å­è®¡ç®—å¤ªæ…¢ï¼Ÿ
A: 1) ä½¿ç”¨å‘é‡åŒ–æ“ä½œ 2) ç¼“å­˜ä¸­é—´ç»“æœ 3) è€ƒè™‘ Numba JIT

### Q: å›æµ‹ç»“æœä¸ç¨³å®šï¼Ÿ
A: 1) æ£€æŸ¥æœªæ¥ä¿¡æ¯æ³„éœ² 2) éªŒè¯äº¤æ˜“æˆæœ¬è®¾ç½® 3) ç¡®è®¤æ—¶é—´åºåˆ—åˆ‡åˆ†

### Q: æ•°æ®ç¼“å­˜å ç”¨å¤ªå¤§ï¼Ÿ
A: 1) ä½¿ç”¨ Parquet å‹ç¼© 2) å®šæœŸæ¸…ç†æ—§æ•°æ® 3) åˆ†æ—¶é—´æ®µå­˜å‚¨

## ğŸ¯ ä»£ç å®¡æŸ¥æ¸…å•

æäº¤ä»£ç å‰æ£€æŸ¥ï¼š
- [ ] é€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼ˆ`pytest test/ -v`ï¼‰
- [ ] ä»£ç ç¬¦åˆ PEP8 è§„èŒƒ
- [ ] æ·»åŠ å¿…è¦çš„ç±»å‹æ³¨è§£å’Œæ–‡æ¡£å­—ç¬¦ä¸²
- [ ] æ›´æ–° CHANGELOG.md
- [ ] æµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
- [ ] æ— ç¡¬ç¼–ç è·¯å¾„å’Œå¯†é’¥
- [ ] æ—¥å¿—ä¿¡æ¯å®Œæ•´æ¸…æ™°

---

**æœ€åæ›´æ–°**: 2025-12-23
**ç»´æŠ¤è€…**: Quant Team

